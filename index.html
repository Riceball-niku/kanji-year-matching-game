<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanji Karuta: Year Numerals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#DC2626', // Red
                        'secondary': '#FCD34D', // Amber
                        'dark-bg': '#1F2937', // Dark Slate
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans CJK JP', 'sans-serif'],
                        serif: ['Noto Serif JP', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the Karuta Cards */
        .karuta-card {
            font-family: 'Noto Serif JP', serif;
            writing-mode: horizontal-tb; /* Use horizontal writing for year numbers */
            transition: all 0.1s ease-in-out;
            transform-style: preserve-3d;
            perspective: 1000px;
            cursor: pointer;
        }
        .karuta-card:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .correct {
            animation: pulse-green 0.5s 1;
            background-color: #10B981 !important; /* Emerald 500 */
        }
        .incorrect {
            animation: shake 0.5s 1;
            background-color: #F87171 !important; /* Red 400 */
        }
        @keyframes pulse-green {
            0% { transform: scale(1); background-color: #10B981; }
            50% { transform: scale(1.05); background-color: #059669; }
            100% { transform: scale(1); background-color: #10B981; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .loading-spinner {
            border-top-color: #DC2626;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to Debug for visibility
        setLogLevel('Debug');

        let app, db, auth;
        let userId = 'loading'; // Default loading state
        let isAuthReady = false;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Global functions (needed to be callable from the main script block)
        // These functions capture the module's 'userId' variable via closure.
        window.saveHighScore = async (mode, score) => {
            if (!isAuthReady || !userId) return;

            const scorePath = `/artifacts/${appId}/users/${userId}/karuta_highscores/score_${mode}`;
            const docRef = doc(db, scorePath);

            try {
                const docSnap = await getDoc(docRef);
                let currentHighScore = docSnap.exists() ? docSnap.data().score : 0;

                if (score > currentHighScore) {
                    await setDoc(docRef, { score: score, mode: mode });
                    document.getElementById('feedback-message').textContent = `New High Score! ${score} points!`;
                    // Update UI immediately
                    window.updateHighScoreUI(mode, score);
                } else {
                    // console.log(`Score ${score} not higher than current high score ${currentHighScore}`);
                }
            } catch (error) {
                console.error("Error saving high score:", error);
            }
        };

        window.loadHighScore = async (mode) => {
            if (!isAuthReady || !userId) return 0;
            const scorePath = `/artifacts/${appId}/users/${userId}/karuta_highscores/score_${mode}`;
            const docRef = doc(db, scorePath);

            try {
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data().score : 0;
            } catch (error) {
                console.error("Error loading high score:", error);
                return 0;
            }
        };

        const initializeFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // Sign in with token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up auth state change listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // console.log("Authenticated. User ID:", userId);
                    } else {
                        // For anonymous sign-in, uid might still be present, but this ensures a fallback
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                        // console.log("Auth state changed. User ID:", userId);
                    }
                    isAuthReady = true;
                    // Start the game logic once auth is ready, passing the resolved userId
                    window.initGame(userId);
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                isAuthReady = true; // Still allow the game to start without persistence
                window.initGame('unauthenticated'); // Fallback user ID
            }
        };

        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</head>
<body class="bg-dark-bg min-h-screen text-white font-sans flex items-center justify-center p-4">

    <div id="loading-screen" class="absolute inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50">
        <div class="loading-spinner w-12 h-12 border-4 border-solid border-gray-600 border-b-primary rounded-full"></div>
        <p class="mt-4 text-gray-400">Loading game data...</p>
    </div>

    <div id="game-container" class="w-full max-w-4xl bg-gray-800 p-6 sm:p-10 rounded-xl shadow-2xl transition-all duration-300 hidden">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-primary tracking-tight">
                Kanji Âπ¥ Karuta
            </h1>
            <p class="text-gray-400 mt-2">Match the Arabic Year to the Kanji Numerals</p>
            <p id="user-id-display" class="text-xs text-gray-500 mt-1"></p>
        </header>

        <!-- Timer, Scoreboard & Mode -->
        <div class="flex flex-col sm:flex-row justify-between items-center bg-gray-700 p-4 rounded-lg mb-6 shadow-inner">
            <div class="text-center sm:text-left mb-3 sm:mb-0">
                <p class="text-lg font-semibold text-secondary">Score: <span id="score-display" class="text-2xl ml-2 font-mono">0</span></p>
            </div>
             <div class="text-center mb-3 sm:mb-0">
                <p class="text-lg font-bold text-red-400">Time: <span id="timer-display" class="text-3xl ml-2 font-mono text-primary">1:00</span></p>
            </div>
            <div class="text-center">
                <p class="text-lg font-semibold text-gray-300">High Score (<span id="mode-name-display" class="capitalize">Beginner</span>): <span id="high-score-display" class="text-2xl ml-2 font-mono">0</span></p>
            </div>
        </div>

        <!-- Mode Selection & Game Controls -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button id="mode-beginner" class="px-6 py-3 text-lg font-bold rounded-lg shadow-md transition duration-200 bg-primary text-white hover:bg-red-700">
                Beginner (1 - 100 Âπ¥)
            </button>
            <button id="mode-challenger" class="px-6 py-3 text-lg font-bold rounded-lg shadow-md transition duration-200 bg-gray-600 text-gray-200 hover:bg-gray-500">
                Challenger (101 - 9000 Âπ¥)
            </button>
            <button id="restart-button" class="px-6 py-3 text-lg font-bold rounded-lg shadow-md transition duration-200 bg-blue-500 text-white hover:bg-blue-600">
                Restart Game
            </button>
        </div>

        <!-- Target Card (Yomi-fuda) -->
        <div class="bg-gray-700 p-6 rounded-xl text-center mb-8 shadow-xl">
            <p class="text-2xl text-gray-300 font-bold mb-2">Find the Kanji for:</p>
            <div id="target-number-display" class="text-8xl sm:text-9xl font-mono font-extrabold text-secondary tracking-wider transition-all duration-300">
                --- Âπ¥
            </div>
        </div>

        <!-- Kanji Choice Cards (Tori-fuda) -->
        <div id="choice-container" class="grid grid-cols-2 gap-4 sm:gap-6">
            <!-- Cards will be generated here -->
        </div>

        <!-- Feedback Message -->
        <div id="feedback-container" class="mt-8 h-8 flex justify-center items-center">
            <p id="feedback-message" class="text-xl font-semibold text-gray-300 transition-all duration-300"></p>
        </div>

        <!-- Modal for Game Over -->
        <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 p-8 rounded-xl max-w-md w-full text-center shadow-2xl border-2 border-primary">
                <h2 class="text-3xl font-bold text-primary mb-4"><span id="modal-title">Game Over!</span></h2>
                <p class="text-xl text-gray-300 mb-6">You scored <span id="final-score" class="text-secondary font-mono font-bold">0</span> points in <span id="final-mode">Beginner</span> mode.</p>
                <button onclick="window.closeModalAndRestart()" class="bg-primary hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                    Play Again
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Global Flags ---
        let audioEnabled = false;
        let currentAudio = null; // NEW: Tracks the currently playing Audio object

        // --- Game State ---
        let gameState = {
            mode: 'beginner',
            score: 0,
            targetKanji: '',
            targetNumber: 0,
            choices: [],
            isPlaying: false,
            highScores: { 'beginner': 0, 'challenger': 0 }
        };

        // --- Timer State ---
        let timerInterval;
        const initialTime = 60; // 1 minute
        let timeRemaining = initialTime;

        // TTS API Constants
        const TTS_API_MODEL = "gemini-2.5-flash-preview-tts";
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_API_MODEL}:generateContent?key=`;
        const TTS_API_KEY = ""; // Canvas runtime provides this
        
        // --- TTS Helper Functions ---

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper to write a string to DataView
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        // Function to convert PCM data (Int16Array) to a WAV Blob
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM

            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');
            
            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Sub-chunk size
            view.setUint16(20, 1, true); // Audio format (1 = Linear PCM)
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true); // Byte rate
            view.setUint16(32, numChannels * bytesPerSample, true); // Block align
            view.setUint16(34, bytesPerSample * 8, true); // Bits per sample

            // DATA sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * bytesPerSample, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += bytesPerSample) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }
        
        // --- TTS Main Function ---
        
        async function speakKanjiNumber(number) {
            // Only proceed if audio has been enabled by user interaction
            if (!audioEnabled) {
                return;
            }

            // FIX: Stop any currently playing audio to prevent overlap
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }

            // --- FIX: Use Arabic numeral for reliable number reading ---
            // The model is highly reliable when reading Arabic numerals with a counter.
            const userPrompt = `Read the following Japanese year number: ${number}Âπ¥.`; 
            
            const payload = {
                contents: [{
                    parts: [{ text: userPrompt }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            // Using 'Kore' as a firm, clear voice
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
            };

            const maxRetries = 3;
            let currentDelay = 1000;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(TTS_API_URL + TTS_API_KEY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API response status: ${response.status}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        // Extract sample rate from mimeType (e.g., audio/L16;rate=24000)
                        const rateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                        
                        const pcmData = base64ToArrayBuffer(audioData);
                        // API returns signed PCM16 audio data.
                        const pcm16 = new Int16Array(pcmData);
                        
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        // Play the audio
                        const audio = new Audio(audioUrl);
                        currentAudio = audio; // Store the new audio object
                        
                        // Clear the reference when playback finishes naturally
                        audio.onended = () => {
                            if (currentAudio === audio) {
                                currentAudio = null;
                            }
                        };

                        audio.play();
                        
                        return; // Success
                    } else {
                        // Throw error if data is missing or wrong type (this is where previous attempts failed)
                        throw new Error("TTS API returned no audio data or invalid structure.");
                    }
                } catch (error) {
                    // console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2; // Exponential backoff
                    } else {
                        // Silent failure: Don't interrupt the user experience if audio fails
                        document.getElementById('feedback-message').textContent = '‚ö†Ô∏è Audio Generation Failed.';
                    }
                }
            }
        }


        // --- Core Kanji Conversion Logic ---

        /**
         * Converts an Arabic numeral into its Japanese Kanji representation (number only).
         */
        function numberToKanji(num) {
            if (num <= 0 || num > 9999) return "„Ç®„É©„Éº";

            const kanjiDigits = ["", "‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠", "‰∏É", "ÂÖ´", "‰πù"];
            let result = '';

            const thou = Math.floor(num / 1000);
            const hund = Math.floor((num % 1000) / 100);
            const tens = Math.floor((num % 100) / 10);
            const unit = num % 10;

            // Thousands (ÂçÉ): 1000 is 'ÂçÉ', 2000 is '‰∫åÂçÉ'
            if (thou > 0) {
                // We trust the model to handle "hassen" reading if we feed it 'ÂÖ´ÂçÉ'
                result += (thou === 1 ? 'ÂçÉ' : kanjiDigits[thou] + 'ÂçÉ');
            }
            // Hundreds (Áôæ): 100 is 'Áôæ', 200 is '‰∫åÁôæ'
            if (hund > 0) {
                result += (hund === 1 ? 'Áôæ' : kanjiDigits[hund] + 'Áôæ');
            }
            // Tens (ÂçÅ): 10 is 'ÂçÅ', 20 is '‰∫åÂçÅ'
            if (tens > 0) {
                result += (tens === 1 ? 'ÂçÅ' : kanjiDigits[tens] + 'ÂçÅ');
            }
            // Units (‰∏Ä): 1-9
            if (unit > 0) {
                result += kanjiDigits[unit];
            }

            if (result === '' && num > 0) {
                 // For single digits 1-9
                return kanjiDigits[num];
            }
            
            return result;
        }


        // --- Utility Functions ---

        /** Generates a unique random number within a range (inclusive) */
        function generateUniqueRandom(min, max, exclude = []) {
            const range = max - min + 1;
            if (range <= exclude.length) {
                return null;
            }
            let num;
            do {
                num = Math.floor(Math.random() * range) + min;
            } while (exclude.includes(num));
            return num;
        }

        /** Shuffles an array */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /** Updates the High Score display */
        window.updateHighScoreUI = (mode, score) => {
            gameState.highScores[mode] = score;
            if (gameState.mode === mode) {
                document.getElementById('high-score-display').textContent = score;
            }
        };

        // --- Timer Functions ---
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer-display').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function countdown() {
            timeRemaining--;
            updateTimerDisplay();

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                timeRemaining = 0;
                updateTimerDisplay();
                endGame(true); // Indicate timer ran out
            }
        }

        // --- Game Logic ---

        function getRange(mode) {
            // Challenger range is 101 to 9000
            return mode === 'beginner' ? { min: 1, max: 100 } : { min: 101, max: 9000 };
        }

        async function loadHighScores() {
            const [beginnerScore, challengerScore] = await Promise.all([
                window.loadHighScore('beginner'),
                window.loadHighScore('challenger')
            ]);
            gameState.highScores['beginner'] = beginnerScore;
            gameState.highScores['challenger'] = challengerScore;
        }

        async function initGame(currentUserId) {
            // Hide loading screen, show game container
            document.getElementById('loading-screen').classList.add('hidden');
            const gameContainer = document.getElementById('game-container');
            gameContainer.classList.remove('hidden');
            
            // Set up one-time audio enablement on first interaction
            gameContainer.addEventListener('click', enableAudioOnFirstInteraction, { once: true });

            // Use the passed user ID
            document.getElementById('user-id-display').textContent = `User ID: ${currentUserId}`;

            await loadHighScores();
            setMode(gameState.mode); // Will call startGame
        }
        
        // This function is called only on the very first user interaction
        function enableAudioOnFirstInteraction() {
            audioEnabled = true;
            document.getElementById('feedback-message').textContent = 'üîä Audio Enabled!';
            // Immediately read the current target number if the game is active
            if (gameState.isPlaying && gameState.targetNumber) {
                speakKanjiNumber(gameState.targetNumber);
            } else {
                 // Clear the feedback message after a short time
                 setTimeout(() => document.getElementById('feedback-message').textContent = '', 2000);
            }
        }


        function setMode(newMode) {
            gameState.mode = newMode;
            document.getElementById('mode-name-display').textContent = newMode.charAt(0).toUpperCase() + newMode.slice(1);
            document.getElementById('high-score-display').textContent = gameState.highScores[newMode];

            // Update button styles
            document.getElementById('mode-beginner').className = 'px-6 py-3 text-lg font-bold rounded-lg shadow-md transition duration-200 ' + (newMode === 'beginner' ? 'bg-primary text-white hover:bg-red-700' : 'bg-gray-600 text-gray-200 hover:bg-gray-500');
            document.getElementById('mode-challenger').className = 'px-6 py-3 text-lg font-bold rounded-lg shadow-md transition duration-200 ' + (newMode === 'challenger' ? 'bg-primary text-white hover:bg-red-700' : 'bg-gray-600 text-gray-200 hover:bg-gray-500');

            startGame();
        }

        function startGame() {
            gameState.score = 0;
            gameState.isPlaying = true;
            document.getElementById('score-display').textContent = 0;
            document.getElementById('feedback-message').textContent = audioEnabled ? 'Match the cards!' : 'Click the cards/buttons to enable audio.';
            document.getElementById('game-over-modal').classList.add('hidden');
            
            // Start Timer
            timeRemaining = initialTime;
            updateTimerDisplay();
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(countdown, 1000);

            generateRound();
        }

        function generateRound() {
            if (!gameState.isPlaying) return;

            const { min, max } = getRange(gameState.mode);
            
            // 1. Pick the correct number (Arabic)
            const correctNum = generateUniqueRandom(min, max);
            gameState.targetNumber = correctNum;
            // Get Kanji ONLY (no Âπ¥)
            gameState.targetKanji = numberToKanji(correctNum);
            
            // 2. Generate false kanji choices
            const falseChoices = new Set();
            while (falseChoices.size < 3) {
                const falseNum = generateUniqueRandom(min, max);
                // Get Kanji ONLY (no Âπ¥)
                const falseKanji = numberToKanji(falseNum);
                // Ensure the false choice is not the correct one and the kanji is unique
                if (falseKanji !== gameState.targetKanji) {
                    falseChoices.add(falseKanji);
                }
            }

            // 3. Combine and shuffle
            gameState.choices = [gameState.targetKanji, ...Array.from(falseChoices)];
            shuffleArray(gameState.choices);

            // 4. Update UI & Speak the number (only if audio is enabled)
            document.getElementById('target-number-display').textContent = correctNum + 'Âπ¥';
            if (audioEnabled) {
                speakKanjiNumber(correctNum); // <--- Speak the number
            } else {
                 document.getElementById('feedback-message').textContent = 'Click the cards/buttons to enable audio.';
            }
            renderChoices();
        }

        function renderChoices() {
            const container = document.getElementById('choice-container');
            container.innerHTML = '';

            // Adjusted font size for better readability of longer Kanji strings: Now 'text-3xl sm:text-4xl'
            const fontSizeClass = 'text-3xl sm:text-4xl';
            
            gameState.choices.forEach((kanji) => {
                const isCorrect = kanji === gameState.targetKanji;

                const card = document.createElement('div');
                // Reduced padding: Now 'p-3 sm:p-6'
                card.className = `karuta-card bg-gray-700 hover:bg-gray-600 text-secondary p-3 sm:p-6 rounded-xl shadow-lg border-b-4 border-secondary flex items-center justify-center font-bold transition duration-150 text-center ${fontSizeClass}`;
                card.textContent = kanji;
                card.dataset.kanji = kanji;
                card.onclick = () => checkAnswer(card, kanji, isCorrect);
                
                container.appendChild(card);
            });
        }

        function checkAnswer(card, selectedKanji, isCorrect) {
            if (!gameState.isPlaying) return;
            if (!timerInterval) return; // Prevent clicks if timer has already expired

            gameState.isPlaying = false; // Disable clicks temporarily
            const feedbackEl = document.getElementById('feedback-message');
            
            if (isCorrect) {
                card.classList.add('correct');
                feedbackEl.textContent = '‚úÖ Correct! +1 Point';
                gameState.score++;
                document.getElementById('score-display').textContent = gameState.score;
                
                // Set timeout for next round
                setTimeout(() => {
                    card.classList.remove('correct');
                    feedbackEl.textContent = audioEnabled ? 'Match the cards!' : 'Click the cards/buttons to enable audio.';
                    gameState.isPlaying = true;
                    generateRound();
                }, 750);
            } else {
                // Incorrect answer immediately ends the game and stops the timer
                clearInterval(timerInterval);
                card.classList.add('incorrect');
                feedbackEl.textContent = '‚ùå Incorrect. Game Over!';
                
                // Show the correct answer
                const correctCard = Array.from(document.getElementById('choice-container').children).find(c => c.dataset.kanji === gameState.targetKanji);
                if (correctCard) {
                    correctCard.style.border = '4px solid #10B981'; // Green border for correct one
                }

                // End the game
                setTimeout(() => {
                    endGame(false);
                }, 1500);
            }
        }

        function endGame(timedOut) {
            clearInterval(timerInterval);
            gameState.isPlaying = false;
            
            // Save the high score asynchronously
            window.saveHighScore(gameState.mode, gameState.score);

            // Update modal
            document.getElementById('final-score').textContent = gameState.score;
            document.getElementById('final-mode').textContent = gameState.mode.charAt(0).toUpperCase() + gameState.mode.slice(1);
            
            document.getElementById('modal-title').textContent = timedOut ? "Time's Up!" : "Game Over!";

            document.getElementById('game-over-modal').classList.remove('hidden');
        }

        window.closeModalAndRestart = () => {
            document.getElementById('game-over-modal').classList.add('hidden');
            // Restart with the current mode
            startGame();
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('mode-beginner').addEventListener('click', () => setMode('beginner'));
            document.getElementById('mode-challenger').addEventListener('click', () => setMode('challenger'));
            document.getElementById('restart-button').addEventListener('click', startGame);
        });

    </script>
</body>
</html>
