<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kanji Year Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background-color: #0f172a; color: white; }
    .karuta-card {
      font-family: "Noto Serif JP", serif;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .karuta-card:hover { transform: scale(1.03); }
    .correct { background-color: #10B981 !important; }
    .incorrect { background-color: #F87171 !important; }
  </style>
</head>

<body class="p-4">

<!-- ===============================
     MAIN MENU
     =============================== -->
<div id="mainMenu" class="text-center mt-10">
  <h1 class="text-3xl font-bold mb-6">ðŸˆ¶ Kanji Year Matching Game</h1>

  <button id="enableAudioBtn"
    class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg mb-6">
    Enable Audio ðŸ”Š
  </button>

  <div class="space-y-4">
    <button id="beginnerBtn"
      class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg w-64">
      Beginner (20â€“100)
    </button>

    <button id="advancedBtn"
      class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg w-64">
      Advanced (101â€“2000)
    </button>
  </div>
</div>

<!-- ===============================
     GAME AREA
     =============================== -->
<div id="gameArea" class="hidden max-w-2xl mx-auto mt-8">

  <div class="flex justify-between mb-4 text-xl">
    <div>Score: <span id="score">0</span></div>
    <div>Q: <span id="qIndex">0</span> / 15</div>
  </div>

  <div class="text-center mb-6">
    <h2 class="text-2xl">Find the Kanji for:</h2>
    <div id="targetNumber" class="text-4xl font-bold mt-2">---å¹´</div>
  </div>

  <div id="choices" class="grid grid-cols-2 gap-4 mb-6"></div>

  <div id="feedback" class="text-center text-2xl h-10"></div>

  <div class="text-center mt-6 space-x-4">
    <button id="restartBtn"
      class="hidden bg-yellow-600 hover:bg-yellow-700 px-5 py-3 rounded-lg">
      Restart
    </button>

    <button id="backBtn"
      class="hidden bg-gray-600 hover:bg-gray-700 px-5 py-3 rounded-lg">
      Back to Main Menu
    </button>
  </div>
</div>

<!-- ===============================
     SCRIPT
     =============================== -->
<script>
/* =============================
   Game configuration & state
   ============================= */
const TOTAL_QUESTIONS = 15;
let level = null;
let score = 0;
let qIndex = 0;
let currentNumber = 0;
let audioEnabled = false;
let waitingAnswer = false;

/* =============================
   DOM
   ============================= */
const mainMenu = document.getElementById('mainMenu');
const gameArea = document.getElementById('gameArea');
const enableAudioBtn = document.getElementById('enableAudioBtn');
const beginnerBtn = document.getElementById('beginnerBtn');
const advancedBtn = document.getElementById('advancedBtn');
const scoreEl = document.getElementById('score');
const qIndexEl = document.getElementById('qIndex');
const targetNumberEl = document.getElementById('targetNumber');
const choicesEl = document.getElementById('choices');
const feedbackEl = document.getElementById('feedback');
const restartBtn = document.getElementById('restartBtn');
const backBtn = document.getElementById('backBtn');

/* =============================
   Kanji conversion
   ============================= */
function numberToKanji(num) {
  if (num <= 0 || num > 9999) return "ã‚¨ãƒ©ãƒ¼";

  const digits = ["","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹"];

  let out = '';
  const thou = Math.floor(num/1000),
        hund = Math.floor((num%1000)/100),
        tens = Math.floor((num%100)/10),
        unit = num % 10;

  if (thou>0) out += (thou===1?'åƒ':digits[thou]+'åƒ');
  if (hund>0) out += (hund===1?'ç™¾':digits[hund]+'ç™¾');
  if (tens>0) out += (tens===1?'å':digits[tens]+'å');
  if (unit>0) out += digits[unit];

  return out + 'å¹´';
}

/* =============================
   Correct hiragana reading
   ============================= */
function numberToReading(num) {
  const digits = ["", "ã„ã¡", "ã«", "ã•ã‚“", "ã‚ˆã‚“", "ã”", "ã‚ã", "ãªãª", "ã¯ã¡", "ãã‚…ã†"];

  function read100s(n) {
    if (n === 0) return "";
    if (n === 1) return "ã²ã‚ƒã";
    if (n === 3) return "ã•ã‚“ã³ã‚ƒã";
    if (n === 6) return "ã‚ã£ã´ã‚ƒã";
    if (n === 8) return "ã¯ã£ã´ã‚ƒã";
    return digits[n] + "ã²ã‚ƒã";
  }

  function read10s(n) {
    if (n === 0) return "";
    if (n === 1) return "ã˜ã‚…ã†";
    return digits[n] + "ã˜ã‚…ã†";
  }

  // Special rule: "4" becomes "ã‚ˆ" before å¹´
  function readOnesBeforeNen(n) {
    if (n === 4) return "ã‚ˆ";
    return digits[n];
  }

  const hundreds = Math.floor(num / 100);
  const tens = Math.floor((num % 100) / 10);
  const ones = num % 10;

  const h = read100s(hundreds);
  const t = read10s(tens);
  const o = readOnesBeforeNen(ones);

  // Combine with spaces for TTS clarity
  return (h + " " + t + " " + o + " ã­ã‚“").replace(/\s+/g, " ").trim();
}

/* =============================
   Speech
   ============================= */
function speakHiragana(str) {
  if (!audioEnabled) return;
  if (!("speechSynthesis" in window)) return;

  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(str);
  u.lang = 'ja-JP';

  setTimeout(() => window.speechSynthesis.speak(u), 80);
}

/* =============================
   Game Flow
   ============================= */
enableAudioBtn.addEventListener('click', () => {
  audioEnabled = true;
  enableAudioBtn.textContent = "Audio Enabled âœ…";
  enableAudioBtn.disabled = true;
  if (window.speechSynthesis.getVoices) window.speechSynthesis.getVoices();
});

beginnerBtn.addEventListener('click', ()=> start('beginner'));
advancedBtn.addEventListener('click', ()=> start('advanced'));
restartBtn.addEventListener('click', ()=> start(level));
backBtn.addEventListener('click', ()=> showMainMenu());

function start(selectedLevel) {
  level = selectedLevel;
  score = 0;
  qIndex = 0;
  currentNumber = 0;

  scoreEl.textContent = 0;
  qIndexEl.textContent = 0;

  mainMenu.classList.add('hidden');
  gameArea.classList.remove('hidden');

  restartBtn.classList.add('hidden');
  backBtn.classList.add('hidden');
  feedbackEl.textContent = '';

  nextQuestion();
}

function nextQuestion() {
  if (qIndex >= TOTAL_QUESTIONS) {
    finishGame();
    return;
  }

  const range = level === 'beginner' ? [20, 100] : [101, 2000];
  currentNumber = Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];

  targetNumberEl.textContent = currentNumber + "å¹´";
  qIndexEl.textContent = qIndex + 1;
  renderChoices(currentNumber);

  speakHiragana(numberToHiragana(currentNumber));

  qIndex++;
}

/* =============================
   Choices
   ============================= */
function renderChoices(correctNum) {
  choicesEl.innerHTML = '';
  waitingAnswer = false;

  const set = new Set();
  set.add(correctNum);

  const range = level === 'beginner' ? [20, 100] : [101, 2000];

  while (set.size < 4) {
    const r = Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];
    set.add(r);
  }

  const arr = Array.from(set).sort(()=> Math.random() - 0.5);

  arr.forEach(n => {
    const card = document.createElement('div');
    card.className = "karuta-card bg-gray-700 p-4 rounded-xl text-2xl text-center";
    card.textContent = numberToKanji(n);
    card.dataset.num = n;
    card.addEventListener('click', ()=> onChoose(card, n));
    choicesEl.appendChild(card);
  });
}

function onChoose(card, chosenNum) {
  if (waitingAnswer) return;
  waitingAnswer = true;

  const correct = chosenNum === currentNumber;

  if (correct) {
    score++;
    scoreEl.textContent = score;
    card.classList.add('correct');
    feedbackEl.textContent = "âœ… Correct!";
  } else {
    card.classList.add('incorrect');
    feedbackEl.textContent = "âŒ Incorrect";

    // Highlight correct answer
    Array.from(choicesEl.children).forEach(c=>{
      if (Number(c.dataset.num) === currentNumber) {
        c.style.boxShadow = "0 0 0 3px rgba(16,185,129,0.45)";
      }
    });
  }

  setTimeout(()=>{
    choicesEl.innerHTML = '';
    feedbackEl.textContent = '';
    nextQuestion();
  }, 700);
}

/* =============================
   End of game
   ============================= */
function finishGame() {
  feedbackEl.textContent = `ðŸŽ‰ Finished! Score: ${score} / ${TOTAL_QUESTIONS}`;
  restartBtn.classList.remove('hidden');
  backBtn.classList.remove('hidden');

  if (audioEnabled) {
    speakHiragana(`Your score is ${score}.`);
  }
}

function showMainMenu() {
  gameArea.classList.add('hidden');
  mainMenu.classList.remove('hidden');

  targetNumberEl.textContent = "---å¹´";
  choicesEl.innerHTML = '';
  feedbackEl.textContent = '';
  restartBtn.classList.add('hidden');
  backBtn.classList.add('hidden');
  scoreEl.textContent = "0";
  qIndexEl.textContent = "0";
}
</script>

</body>
</html>
