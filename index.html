<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kanji Year Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .karuta-card {
      font-family: "Noto Serif JP", serif;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .karuta-card:hover { transform: scale(1.03); }
    .correct { background-color: #10B981 !important; }
    .incorrect { background-color: #F87171 !important; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-start p-4">

  <!-- Main Menu -->
  <div id="mainMenu" class="flex flex-col items-center space-y-4">
    <h1 class="text-4xl font-bold">Kanji Year Quiz</h1>
    <button id="enableAudioBtn" class="px-6 py-2 bg-blue-600 rounded hover:bg-blue-500">Enable Audio</button>
    <div class="flex space-x-4">
      <button id="beginnerBtn" class="px-6 py-2 bg-green-600 rounded hover:bg-green-500">Beginner</button>
      <button id="advancedBtn" class="px-6 py-2 bg-red-600 rounded hover:bg-red-500">Advanced</button>
    </div>
  </div>

  <!-- Game Area -->
  <div id="gameArea" class="hidden w-full max-w-xl flex flex-col items-center space-y-4 mt-6">
    <div class="text-xl">Question <span id="qIndex">0</span> / 15</div>
    <div class="text-3xl font-bold" id="targetNumber">---å¹´</div>
    <div id="choices" class="grid grid-cols-2 gap-4 w-full"></div>
    <div id="feedback" class="text-xl h-8"></div>
    <div class="flex space-x-4 mt-4">
      <button id="restartBtn" class="px-6 py-2 bg-yellow-600 rounded hover:bg-yellow-500 hidden">Restart</button>
      <button id="backBtn" class="px-6 py-2 bg-gray-600 rounded hover:bg-gray-500 hidden">Back to Main</button>
    </div>
    <div class="mt-4">Score: <span id="score">0</span></div>
  </div>

  <!-- Script -->
  <script>
/* =============================
   Game configuration & state
   ============================= */
const TOTAL_QUESTIONS = 15;
let level = null;
let score = 0;
let qIndex = 0;
let currentNumber = 0;
let audioEnabled = false;
let waitingAnswer = false;

/* =============================
   DOM elements
   ============================= */
const mainMenu = document.getElementById('mainMenu');
const gameArea = document.getElementById('gameArea');
const enableAudioBtn = document.getElementById('enableAudioBtn');
const beginnerBtn = document.getElementById('beginnerBtn');
const advancedBtn = document.getElementById('advancedBtn');
const scoreEl = document.getElementById('score');
const qIndexEl = document.getElementById('qIndex');
const targetNumberEl = document.getElementById('targetNumber');
const choicesEl = document.getElementById('choices');
const feedbackEl = document.getElementById('feedback');
const restartBtn = document.getElementById('restartBtn');
const backBtn = document.getElementById('backBtn');

/* =============================
   Kanji conversion
   ============================= */
function numberToKanji(num) {
  if (num <= 0 || num > 9999) return "ã‚¨ãƒ©ãƒ¼";
  const digits = ["","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹"];
  let out = '';
  const thou = Math.floor(num/1000),
        hund = Math.floor((num%1000)/100),
        tens = Math.floor((num%100)/10),
        unit = num % 10;
  if (thou>0) out += (thou===1?'åƒ':digits[thou]+'åƒ');
  if (hund>0) out += (hund===1?'ç™¾':digits[hund]+'ç™¾');
  if (tens>0) out += (tens===1?'å':digits[tens]+'å');
  if (unit>0) out += digits[unit];
  return out + 'å¹´';
}

/* =============================
   Correct Hiragana reading with irregulars
   ============================= */
function numberToReading(num) {
  if (num <= 0 || num > 9999) return "ã‚Œã„ã­ã‚“";

  const digits = ["", "ã„ã¡","ã«","ã•ã‚“","ã‚ˆ","ã”","ã‚ã","ãªãª","ã¯ã¡","ãã‚…ã†"];
  let reading = "";

  // Thousands (1000â€“9000)
  const thou = Math.floor(num / 1000);
  if (thou > 0) {
    switch(thou) {
      case 1: reading += "ã›ã‚“"; break;
      case 3: reading += "ã•ã‚“ãœã‚“"; break;
      case 8: reading += "ã¯ã£ã›ã‚“"; break;
      default: reading += digits[thou] + "ã›ã‚“"; break;
    }
  }

  // Hundreds (100â€“900)
  const hund = Math.floor((num % 1000) / 100);
  if (hund > 0) {
    switch(hund) {
      case 1: reading += "ã²ã‚ƒã"; break;
      case 2: reading += "ã«ã²ã‚ƒã"; break;
      case 3: reading += "ã•ã‚“ã³ã‚ƒã"; break;
      case 4: reading += "ã‚ˆã‚“ã²ã‚ƒã"; break;
      case 5: reading += "ã”ã²ã‚ƒã"; break;
      case 6: reading += "ã‚ã£ã´ã‚ƒã"; break;
      case 7: reading += "ãªãªã²ã‚ƒã"; break;
      case 8: reading += "ã¯ã£ã´ã‚ƒã"; break;
      case 9: reading += "ãã‚…ã†ã²ã‚ƒã"; break;
    }
  }

  // Tens (10â€“90)
  const tens = Math.floor((num % 100) / 10);
  if (tens > 0) {
    if (tens === 1) reading += "ã˜ã‚…ã†";
    else reading += digits[tens] + "ã˜ã‚…ã†";
  }

  // Ones (1â€“9)
  const ones = num % 10;
  if (ones > 0) {
    // Special rule: 4 before å¹´ becomes "ã‚ˆ"
    if (ones === 4) reading += "ã‚ˆ";
    else reading += digits[ones];
  }

  return reading + "ã­ã‚“";
}


/* =============================
   Speech
   ============================= */
function speakHiragana(str) {
  if (!audioEnabled) return;
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(str);
  u.lang = 'ja-JP';
  setTimeout(()=>window.speechSynthesis.speak(u), 80);
}

/* =============================
   Game Flow
   ============================= */
enableAudioBtn.addEventListener('click', () => {
  audioEnabled = true;
  enableAudioBtn.textContent = "Audio Enabled âœ…";
  enableAudioBtn.disabled = true;
  if (window.speechSynthesis.getVoices) window.speechSynthesis.getVoices();
});

beginnerBtn.addEventListener('click', ()=> start('beginner'));
advancedBtn.addEventListener('click', ()=> start('advanced'));
restartBtn.addEventListener('click', ()=> start(level));
backBtn.addEventListener('click', ()=> showMainMenu());

function start(selectedLevel) {
  level = selectedLevel;
  score = 0; qIndex = 0; currentNumber=0;
  scoreEl.textContent = 0;
  qIndexEl.textContent = 0;
  mainMenu.classList.add('hidden');
  gameArea.classList.remove('hidden');
  restartBtn.classList.add('hidden'); backBtn.classList.add('hidden');
  feedbackEl.textContent = '';
  nextQuestion();
}

function nextQuestion() {
  if (qIndex >= TOTAL_QUESTIONS) { finishGame(); return; }
  const range = level==='beginner'? [20,100]:[101,2000];
  currentNumber = Math.floor(Math.random()*(range[1]-range[0]+1))+range[0];
  targetNumberEl.textContent = currentNumber+"å¹´";
  qIndexEl.textContent = qIndex+1;
  renderChoices(currentNumber);
  speakHiragana(numberToReading(currentNumber));
  qIndex++;
}

/* =============================
   Choices
   ============================= */
function renderChoices(correctNum) {
  choicesEl.innerHTML='';
  waitingAnswer=false;
  const set = new Set();
  set.add(correctNum);
  const range = level==='beginner'? [20,100]:[101,2000];
  while(set.size<4) set.add(Math.floor(Math.random()*(range[1]-range[0]+1))+range[0]);
  const arr = Array.from(set).sort(()=>Math.random()-0.5);
  arr.forEach(n=>{
    const card = document.createElement('div');
    card.className="karuta-card bg-gray-700 p-4 rounded-xl text-2xl text-center";
    card.textContent=numberToKanji(n);
    card.dataset.num=n;
    card.addEventListener('click', ()=> onChoose(card,n));
    choicesEl.appendChild(card);
  });
}

function onChoose(card, chosenNum) {
  if(waitingAnswer) return;
  waitingAnswer=true;
  const correct = chosenNum===currentNumber;
  if(correct){ score++; scoreEl.textContent=score; card.classList.add('correct'); feedbackEl.textContent="âœ… Correct!"; }
  else { card.classList.add('incorrect'); feedbackEl.textContent="âŒ Incorrect"; 
    Array.from(choicesEl.children).forEach(c=>{ if(Number(c.dataset.num)===currentNumber) c.style.boxShadow="0 0 0 3px rgba(16,185,129,0.45)"; });
  }
  setTimeout(()=>{
    choicesEl.innerHTML=''; feedbackEl.textContent=''; waitingAnswer=false;
    nextQuestion();
  },700);
}

/* =============================
   End of game
   ============================= */
function finishGame(){
  feedbackEl.textContent=`ðŸŽ‰ Finished! Score: ${score} / ${TOTAL_QUESTIONS}`;
  restartBtn.classList.remove('hidden'); backBtn.classList.remove('hidden');
  if(audioEnabled){
    const reading = `Your score is ${score}.`;
    speakHiragana(reading);
  }
}

function showMainMenu(){
  gameArea.classList.add('hidden'); mainMenu.classList.remove('hidden');
  targetNumberEl.textContent="---å¹´"; choicesEl.innerHTML=''; feedbackEl.textContent='';
  restartBtn.classList.add('hidden'); backBtn.classList.add('hidden');
  scoreEl.textContent="0"; qIndexEl.textContent="0";
}
  </script>
</body>
</html>
